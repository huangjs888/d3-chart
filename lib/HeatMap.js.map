{"version":3,"sources":["../src/HeatMap.js"],"names":["prefixSIFormat","d3","format","findValIndex","val","arr","n1","n2","length","c","binSize","n","test","a","b","v","Math","floor","window","console","log","min","max","computeFactor","val0","val1","bin0","bin1","factor","getInterpFactor","pixel","valPixs","index0","index1","matrixAverage","xFactor","val00","val01","yFactor","val10","val11","undefined","dx","dy","dxy","valueForPixel","value","reverse","len","minVal","maxVal","i","round","matrixInterp","w","h","d","x","y","z","x0","y0","x1","y1","cw","ch","xValPixs","yValPixs","pixels","index","Uint8Array","e","Array","xInterpArray","j","yInterp","xInterp","chasm","xbin","noChasm","findIndex","o","r","g","opacity","drawend","zContext","xScale","yScale","save","clearRect","width$","height$","showHeat$","zScale","zScale$","viewRange","data","heat","xMinPx","xMaxPx","yMinPx","yMaxPx","width","height","xcMinPx","xcMaxPx","ycMinPx","ycMaxPx","xMin","xMax","yMin","yMax","dataRange","cWidth","cHeight","pixelData","rgba","color","imageData","createImageData","set","cdata","putImageData","canvas","tempCanvas$","getContext","range","map","invert","restore","drawing","lineMark","xp","datum","style","drawImage","tipCompute","prevRes","point","scaleAxis","scaleOpt","scale","tooptip","cross","average","crossX","indexOf","crossY","x2","y2","xyzValue","xval","yval","zval","util","findNearIndex","xi0","xi1","yi0","yi1","xval0","xval1","yval0","yval1","xi","abs","yi","push","prevValue","slice","ndata","result","selection","selectAll","join","attr","html","label","unit","updateScale","domain","copy","clamp","doubleClick","HeatMap","restOptions","restData","compute","res","args","call","tempText","subLabel","heatLabel","rootSelection$","select","append","padding","measureSvgText","fontSize","text","zoomSelection$","zCanvasParent","insert","zCanvas","node","scaleLinear","document","createElement","dblclick$$","dblclick$","pointer","sourceEvent","contextmenu$$","contextmenu$","zooming$$","zooming$","zoomend$$","zoomend$","debounceDrawend$","debounce","leading","trailing","type","delay","flush","resize$$","resize$","rest","on","destroyed","rendered","render","computeDomain","needDomain","heatData","domains","forEach","key","extent","svgDiv","left","parseInt","top","image","cancel","BaseChart"],"mappings":"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","sourcesContent":["/*\n * @Author: Huangjs\n * @Date: 2021-03-17 16:23:00\n * @LastEditors: Huangjs\n * @LastEditTime: 2021-10-26 18:09:36\n * @Description: ******\n */\n\nimport * as d3 from 'd3';\nimport BaseChart from './BaseChart';\nimport * as util from './util';\n\nconst prefixSIFormat = d3.format('~s');\n\nconst findValIndex = (val, arr) => {\n  let n1 = 0;\n  let n2 = arr.length;\n  let c = 0;\n  const binSize = n2 > 1 ? (arr[n2 - 1] - arr[0]) / (n2 - 1) : 1;\n  let n;\n  let test;\n  if (binSize >= 0) {\n    test = (a, b) => a <= b;\n  } else {\n    test = (a, b) => a > b;\n  }\n  // don't trust floating point equality - fraction of bin size to call\n  const v = val + binSize * 1e-9 * (binSize >= 0 ? 1 : -1);\n  // c is just to avoid infinite loops if there's an error\n  while (n1 < n2 && c < 100) {\n    c += 1;\n    n = Math.floor((n1 + n2) / 2);\n    if (test(arr[n], v)) n1 = n + 1;\n    else n2 = n;\n  }\n  if (c > 90) window.console.log('Long binary search...');\n  return Math.min(Math.max(n1 - 1, 0), arr.length - 1);\n};\n// 计算两值之间任意值占比以及前后值\nconst computeFactor = (val, val0, val1, bin0, bin1) => {\n  const factor = (val - val0) / (val1 - val0) || 0;\n  if (factor <= 0) {\n    return {\n      factor: 0,\n      bin0,\n      bin1: bin0,\n    };\n  }\n  if (factor > 0.5) {\n    return {\n      factor: 1 - factor,\n      bin0: bin1,\n      bin1: bin0,\n    };\n  }\n  return {\n    factor,\n    bin0,\n    bin1,\n  };\n};\n// 计算每个像素对应值的插值计算比例\nconst getInterpFactor = (pixel, valPixs) => {\n  const index0 = findValIndex(pixel, valPixs);\n  const index1 = index0 + 1;\n  return computeFactor(pixel, valPixs[index0], valPixs[index1], index0, index1);\n};\n// 根据四个点计算中间点的平均值\nconst matrixAverage = (xFactor, val00, val01, yFactor, val10, val11) => {\n  let val = 0;\n  if (val00 !== undefined) {\n    const dx = val01 - val00 || 0;\n    const dy = val10 - val00 || 0;\n    let dxy = 0;\n    if (val01 === undefined) {\n      if (val11 === undefined) dxy = 0;\n      else if (val10 === undefined) dxy = 2 * (val11 - val00);\n      else dxy = ((2 * val11 - val10 - val00) * 2) / 3;\n    } else if (val11 === undefined) {\n      if (val10 === undefined) dxy = 0;\n      else dxy = ((2 * val00 - val01 - val10) * 2) / 3;\n    } else if (val10 === undefined) dxy = ((2 * val11 - val01 - val00) * 2) / 3;\n    else dxy = val11 + val00 - val01 - val10;\n    val = val00 + (xFactor || 0) * dx + (yFactor || 0) * (dy + xFactor * dxy);\n  }\n  return val;\n};\n// 将给定值数组中的值映射到给定长度的每一个像素点上\n// 若值数组长度比像素点多，则会均匀抽稀映射\n// 若值数组长度比像素点少，则会平滑插值映射\nconst valueForPixel = (value, pixel, reverse) => {\n  const valPixs = [];\n  const len = value.length;\n  const minVal = value[0];\n  const maxVal = value[len - 1];\n  for (let i = 0; i < len; i += 1) {\n    valPixs[reverse ? len - 1 - i : i] = Math.round(\n      Math.round(100 * pixel * ((value[i] - minVal) / (maxVal - minVal))) / 100\n    );\n  }\n  return valPixs;\n};\n// 矩阵插值上色（根据矩形四个点值，计算矩形内部所有像素点的值，并渲染颜色）\nconst matrixInterp = ({ w, h, d }, { x, y, z }, c) => {\n  const [[x0, y0], [x1, y1]] = d;\n  const cw = x1 - x0;\n  const ch = y1 - y0;\n  const xValPixs = valueForPixel(x, w);\n  const yValPixs = valueForPixel(y, h, true);\n  let pixels;\n  let index = 0;\n  try {\n    pixels = new Uint8Array(cw * ch * 4);\n  } catch (e) {\n    pixels = new Array(cw * ch * 4);\n  }\n  const xInterpArray = [];\n  for (let j = y0; j < y1; j += 1) {\n    const yInterp = getInterpFactor(j, yValPixs);\n    const val0 = z[yInterp.bin0];\n    const val1 = z[yInterp.bin1];\n    for (let i = x0; i < x1; i += 1) {\n      let xInterp = xInterpArray[i];\n      if (!xInterp) {\n        xInterp = getInterpFactor(i, xValPixs);\n        xInterpArray[i] = xInterp;\n      }\n      const chasm = x.chasm || [];\n      const xbin = Math.max(xInterp.bin0, xInterp.bin1);\n      const noChasm = chasm.findIndex((o) => o === xbin) === -1;\n      const { r, g, b, opacity } = noChasm\n        ? c(\n            matrixAverage(\n              xInterp.factor,\n              val0[xInterp.bin0],\n              val0[xInterp.bin1],\n              yInterp.factor,\n              val1[xInterp.bin0],\n              val1[xInterp.bin1]\n            )\n          )\n        : { r: 0, g: 0, b: 0, opacity: 0 };\n      pixels[index] = r;\n      pixels[index + 1] = g;\n      pixels[index + 2] = b;\n      pixels[index + 3] = opacity * 255; // 透明度0-1需要转换成0-255\n      index += 4;\n    }\n  }\n  return pixels;\n};\n\nfunction drawend(zContext, { xScale, yScale }) {\n  zContext.save();\n  // 先清空画布\n  zContext.clearRect(0, 0, this.width$, this.height$);\n  if (this.showHeat$) {\n    const zScale = this.zScale$;\n    let viewRange = null;\n    const { x, y, z } = this.data.heat;\n    // 原始范围\n    // 根据xy轴的刻度变换函数分别计算出原始数据图的上下左右坐标位置\n    const xMinPx = xScale(x[0] || 0);\n    const xMaxPx = xScale(x[x.length - 1] || 0);\n    // 因为y坐标是反转的（domain和range大小反转对应）\n    const yMinPx = yScale(y[y.length - 1] || 0);\n    const yMaxPx = yScale(y[0] || 0);\n    // 原始数据的实际宽高\n    const width = Math.round(xMaxPx - xMinPx);\n    const height = Math.round(yMaxPx - yMinPx);\n    // 如果实际的宽高小于或等于0则表示压根没有数据\n    if (width > 0 && height > 0) {\n      // 画布范围\n      // 画布上下左右坐标位置，this.width$, this.height$是画布的宽高\n      const xcMinPx = 0;\n      const xcMaxPx = this.width$ + xcMinPx;\n      const ycMinPx = 0;\n      const ycMaxPx = this.height$ + ycMinPx;\n      // 真实渲染的数据，是原始数据的范围，配置中筛选的范围以及画布的范围最终确定\n      // 根据以上三个范围计算确定真正需要渲染的范围，要考虑此范围的两个问题：\n      // 1，对于原始数据段转换的像素范围，应该选择哪一段像素去渲染？\n      // 2，对于视图，这一段数据应该渲染在画布上哪一个范围（在画布内部的位置）？\n      // 以下计算需要渲染的像素段在原始数据像素范围内（宽和高）起点和终点的索引\n      const xMin = Math.max(xcMinPx, xMinPx); // 取x最小范围中的最大值\n      const xMax = Math.min(xcMaxPx, xMaxPx); // 取x最大范围中的最小值\n      const yMin = Math.max(ycMinPx, yMinPx); // 取y最小范围中的最大值\n      const yMax = Math.min(ycMaxPx, yMaxPx); // 取y最大范围中的最小值\n      // 实际被裁减后的宽高（可能等于画布宽高，也可能小于，但是不会大于因为被裁掉了）\n      const dataRange = [\n        [Math.round(xMin - xMinPx), Math.round(yMin - yMinPx)], // 筛选后数据在原数据的起点index\n        [Math.round(xMax - xMinPx), Math.round(yMax - yMinPx)], // 筛选后数据在原数据的终点index\n      ];\n      const cWidth = dataRange[1][0] - dataRange[0][0];\n      const cHeight = dataRange[1][1] - dataRange[0][1];\n      // 如果裁剪后的宽高小于或等于0则表示没有可以渲染的数据了\n      if (cWidth > 0 && cHeight > 0) {\n        // 计算出渲染图片的每个像素rgba值\n        const pixelData = matrixInterp(\n          {\n            w: width,\n            h: height,\n            d: dataRange,\n          },\n          { x, y, z },\n          (v) => {\n            // 老版本d3得到的rgba是字符串，新版本d3是对象，这里做个兼容\n            const rgba = zScale(v);\n            return typeof rgba === 'string' ? d3.color(rgba) : rgba;\n          }\n        );\n        // 创建一个空的图片数据（使用裁剪后的宽高）\n        const imageData = zContext.createImageData(cWidth, cHeight);\n        // 将像素数据设置到图片数据内\n        try {\n          imageData.data.set(pixelData);\n        } catch (e) {\n          const cdata = imageData.data;\n          const len = cdata.length;\n          for (let i = 0; i < len; i += 1) {\n            cdata[i] = pixelData[i];\n          }\n        }\n        // 以下计在算在画布上需要渲染的范围起点和终点的位置（相对于画布）\n        viewRange = [\n          [xMin - xcMinPx, yMin - ycMinPx],\n          [xMax - xcMinPx, yMax - ycMinPx],\n        ];\n        // 将计算好的数据放到画布\n        zContext.putImageData(imageData, Math.round(viewRange[0][0]), Math.round(viewRange[0][1]));\n        const { canvas } = this.tempCanvas$;\n        if (canvas) {\n          // 存储渲染后的裁剪数据和图片数据\n          canvas.width = cWidth;\n          canvas.height = cHeight;\n          canvas.getContext('2d').putImageData(imageData, 0, 0);\n        }\n      }\n    }\n    this.tempCanvas$.range = !viewRange\n      ? null\n      : viewRange.map((r) => r.map((v, i) => (i === 0 ? xScale : yScale).invert(v)));\n  }\n  zContext.restore();\n}\n\nfunction drawing(zContext, { xScale, yScale }, lineMark) {\n  if (this.showHeat$) {\n    const xp = xScale(lineMark.datum()) || 0;\n    lineMark.style('left', `${xp}px`).style('visibility', xp < 0 || xp > this.width$ ? 'hidden' : 'visible');\n    const { canvas, range } = this.tempCanvas$;\n    if (range) {\n      // 将上一次变换后的图，经过本次变换的变形重新绘制到画布上\n      const [[x0, y0], [x1, y1]] = range.map((r) => r.map((v, i) => (i === 0 ? xScale : yScale)(v)));\n      zContext.save();\n      zContext.clearRect(0, 0, this.width$, this.height$);\n      zContext.drawImage(canvas, x0, y0, x1 - x0, y1 - y0);\n      zContext.restore();\n    }\n  }\n}\n\nfunction tipCompute(prevRes, point, scaleAxis) {\n  const data = this.data.heat;\n  const scaleOpt = this.scale;\n  const { cross, average } = this.tooptip;\n  const crossX = cross.indexOf('x') !== -1;\n  const crossY = cross.indexOf('y') !== -1;\n  const xScale = scaleAxis.x ? scaleAxis.x.scale : scaleAxis.x2.scale;\n  const yScale = scaleAxis.y ? scaleAxis.y.scale : scaleAxis.y2.scale;\n  let [x0, y0] = point;\n  const xyzValue = [];\n  if (this.showHeat$ && crossX && crossY) {\n    let xval = xScale.invert(x0);\n    let yval = yScale.invert(y0);\n    let zval = 0;\n    const [xi0, xi1] = util.findNearIndex(+xval, data.x);\n    const [yi0, yi1] = util.findNearIndex(+yval, data.y);\n    if (xi0 >= 0 && xi1 >= 0 && yi0 >= 0 && yi1 >= 0) {\n      const xval0 = +data.x[xi0];\n      const xval1 = +data.x[xi1];\n      const yval0 = +data.y[yi0];\n      const yval1 = +data.y[yi1];\n      if (xval0 === xval1 && yval0 === yval1) {\n        // 正好移动到了xy交叉数据点上\n        zval = data.z[yi0][xi0];\n      } else if (average) {\n        const xInterp = computeFactor(+xval, xval0, xval1, xi0, xi1);\n        const yInterp = computeFactor(+yval, yval0, yval1, yi0, yi1);\n        const val00 = data.z[yInterp.bin0][xInterp.bin0];\n        const val01 = data.z[yInterp.bin0][xInterp.bin1];\n        const val10 = data.z[yInterp.bin1][xInterp.bin0];\n        const val11 = data.z[yInterp.bin1][xInterp.bin1];\n        zval = matrixAverage(xInterp.factor, val00, val01, yInterp.factor, val10, val11);\n      } else {\n        const xi = Math.abs(xval - xval0) > Math.abs(xval - xval1) ? xi1 : xi0;\n        const yi = Math.abs(yval - yval0) > Math.abs(yval - yval1) ? yi1 : yi0;\n        xval = +data.x[xi];\n        yval = +data.y[yi];\n        zval = data.z[yi][xi];\n        x0 = xScale(xval);\n        y0 = yScale(yval);\n      }\n      xyzValue.push(\n        {\n          ...scaleOpt[scaleAxis.x ? 'x' : 'x2'],\n          value: xval,\n        },\n        {\n          ...scaleOpt[scaleAxis.y ? 'y' : 'y2'],\n          value: yval,\n        },\n        {\n          ...scaleOpt.z,\n          value: zval,\n        }\n      );\n    }\n  }\n  if (xyzValue.length > 0) {\n    // 去掉第一个因为第一个是标题\n    const prevValue = (prevRes.data || []).slice(1);\n    const ndata = [...xyzValue, ...prevValue];\n    const result = (selection) => {\n      selection\n        .selectAll('div')\n        .data(ndata)\n        .join('div')\n        .attr('style', 'white-space: nowrap;')\n        .html((d, i) =>\n          i === 0\n            ? `${d.label}：${d.format(d.value)}${d.unit}`\n            : `${\n                !d.color\n                  ? ''\n                  : `<span style=\"background: ${d.color}; width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px;\"></span>`\n              }<span>${d.label}</span>: <span style=\"display: inline-block; ${\n                !d.color ? '' : 'margin-left: 30px;'\n              }\">${d.format(d.value)}${d.unit}</span>`\n        );\n    };\n    return { x0, y0, data: ndata, result };\n  }\n  return { ...prevRes };\n}\n\nfunction updateScale() {\n  if (this.scale.z) {\n    const [opacity, range, domain] = this.scale.z.domain || [];\n    this.zScale$\n      .range((range || ['#fff', '#fff']).map((c) => d3.color(c).copy({ opacity: opacity || 0 })))\n      .domain(domain || [0, 0])\n      .clamp(true); // 设置true可以卡住所给不在domain中的参数生成的数据仍然在range范围内\n  }\n}\n\nfunction doubleClick(point, xScale, lineMark) {\n  if (!this.showHeat$) {\n    return null;\n  }\n  const data = this.data.heat;\n  const { average } = this.tooptip;\n  let [x0] = point;\n  let z = [];\n  let x = xScale.invert(x0);\n  const xi = util.findNearIndex(+x, data.x, !average);\n  if (average) {\n    const [xi0, xi1] = xi;\n    if (xi0 < 0) {\n      z = data.z.map((v) => v[xi1]);\n      x = data.x[xi1];\n      x0 = xScale(x);\n    } else if (xi1 < 0) {\n      z = data.z.map((v) => v[xi0]);\n      x = data.x[xi0];\n      x0 = xScale(x);\n    } else {\n      const xInterp = computeFactor(+x, +data.x[xi0], +data.x[xi1], xi0, xi1);\n      z = data.z.map((v) => matrixAverage(xInterp.factor, v[xInterp.bin0], v[xInterp.bin1]));\n    }\n  } else {\n    z = data.z.map((v) => v[xi]);\n    x = data.x[xi];\n    x0 = xScale(x);\n  }\n  lineMark.style('left', `${x0}px`).style('display', 'block').datum(x);\n  return { x, y: data.y, z };\n}\n\nclass HeatMap extends BaseChart {\n  constructor(...params) {\n    const { data, tooptip, scale, ...restOptions } = params[0] || {};\n    const { heat, ...restData } = data || {};\n    super({\n      ...restOptions,\n      data: {\n        heat: !heat ? { x: [], y: [], z: [] } : { x: heat.x || [], y: heat.y || [], z: heat.z || [] },\n        ...restData,\n      },\n      tooptip: !tooptip\n        ? false\n        : {\n            cross: 'xy',\n            average: true,\n            ...tooptip,\n            compute: (res, ...args) => {\n              let result = tipCompute.call(this, res, ...args);\n              if (typeof tooptip.compute === 'function') {\n                result = tooptip.compute.call(this, result, ...args);\n              }\n              return result;\n            },\n          },\n      scale: {\n        /* z: {\n          type: 'linear', // 坐标类型\n          ticks: 5, // 坐标刻度数目\n          format: (v) => v, // 坐标值格式化函数\n          domain: [0, ['#fff', '#fff'], [0, 0]], // 值的色域范围和透明度\n          label: '', // 坐标名称\n          unit: '', // 坐标值单位\n        }, */\n        z: { format: prefixSIFormat },\n        ...scale,\n      },\n    });\n    this.showHeat$ = true;\n    const tempText = `${this.scale.z.label || ''}${this.scale.z.subLabel ? ` ( ${this.scale.z.subLabel} )` : ''}${\n      this.scale.z.unit ? ` ( ${this.scale.z.unit} )` : ''\n    }`;\n    const heatLabel = this.rootSelection$\n      .select('g.group')\n      .append('g')\n      .attr('class', 'heatLabel')\n      .attr('fill', 'currentColor')\n      .attr('dominant-baseline', 'text-before-edge')\n      .attr('transform', `translate(${this.scale.y ? 10 : this.width$ - 10},${this.scale.x2 ? 0 : -this.padding[0]})`);\n    heatLabel\n      .append('text')\n      .attr('dx', util.measureSvgText(tempText, this.fontSize) / 2)\n      .text(tempText);\n    const lineMark = this.zoomSelection$\n      .append('div')\n      .attr('class', 'line-mark')\n      .style('background', '#fa9305')\n      .style('display', 'none')\n      .style('position', 'absolute')\n      .style('top', 0)\n      .style('left', 0)\n      .style('width', '1px')\n      .style('height', '100%');\n    const zCanvasParent = this.rootSelection$\n      .insert('div', 'svg')\n      .style('position', 'absolute')\n      .style('width', `${this.width$}px`)\n      .style('height', `${this.height$}px`)\n      .style('top', `${this.padding[0]}px`)\n      .style('left', `${this.padding[3] + 1}px`);\n    const zCanvas = zCanvasParent\n      .append('canvas')\n      .style('width', '100%')\n      .style('height', '100%')\n      .attr('width', this.width$)\n      .attr('height', this.height$);\n    const zContext = zCanvas.node().getContext('2d');\n    this.zScale$ = d3.scaleLinear();\n    updateScale.call(this);\n    this.tempCanvas$ = {\n      canvas: document.createElement('canvas'),\n      range: null,\n    };\n    const dblclick$$ = this.dblclick$;\n    this.dblclick$ = (e, ...args) => {\n      dblclick$$.call(null, e, ...args);\n      const { x } = e.scaleAxis;\n      const xScale = x.scale;\n      return doubleClick.call(this, d3.pointer(e.sourceEvent), xScale, lineMark);\n    };\n    const contextmenu$$ = this.contextmenu$;\n    this.contextmenu$ = (e, ...args) => {\n      contextmenu$$.call(null, e, ...args);\n      lineMark.style('display', 'none');\n    };\n    const zooming$$ = this.zooming$;\n    this.zooming$ = (e, ...args) => {\n      zooming$$.call(null, e, ...args);\n      const { x, y } = e.scaleAxis;\n      const xScale = x.scale;\n      const yScale = y.scale;\n      drawing.call(this, zContext, { xScale, yScale }, lineMark);\n    };\n    const zoomend$$ = this.zoomend$;\n    this.debounceDrawend$ = util.debounce(drawend, 450, { leading: false, trailing: true });\n    this.zoomend$ = (e, ...args) => {\n      zoomend$$.call(null, e, ...args);\n      const { x, y } = e.scaleAxis;\n      const xScale = x.scale;\n      const yScale = y.scale;\n      this.debounceDrawend$.call(this, zContext, { xScale, yScale });\n      if (e.sourceEvent.type === 'call') {\n        util.delay(() => {\n          this.debounceDrawend$.flush();\n        }, 1);\n      }\n    };\n    const resize$$ = this.resize$;\n    this.resize$ = (e, { width, height, padding, ...rest }, ...args) => {\n      resize$$.call(null, e, { width, height, padding, ...rest }, ...args);\n      zCanvasParent\n        .style('width', `${width}px`)\n        .style('height', `${height}px`)\n        .style('top', `${padding[0]}px`)\n        .style('left', `${padding[3] + 1}px`);\n      zCanvas.attr('width', width).attr('height', height);\n      heatLabel.attr('transform', `translate(${this.scale.y ? 10 : width - 10},${this.scale.x2 ? 0 : -padding[0]})`);\n    };\n    heatLabel.on('click', () => {\n      if (this.destroyed) return;\n      this.showHeat$ = !this.showHeat$;\n      lineMark.style('display', this.showHeat$ ? 'block' : 'none');\n      heatLabel.attr('fill', !this.showHeat$ ? '#aaaa' : 'currentColor');\n      if (this.rendered) {\n        this.render();\n      }\n    });\n  }\n\n  setData(data, render, computeDomain) {\n    if (!data) return this;\n    const { heat, ...restData } = data || {};\n    super.setData(\n      {\n        heat: !heat ? { x: [], y: [], z: [] } : { x: heat.x || [], y: heat.y || [], z: heat.z || [] },\n        ...restData,\n      },\n      false,\n      !heat\n        ? computeDomain\n        : ({ heat: heatData }, needDomain) => {\n            const domains = {};\n            needDomain.forEach((key) => {\n              if (heatData[key] && heatData[key].length > 0) {\n                domains[key] = d3.extent([...heatData[key]]);\n              }\n            });\n            return domains;\n          }\n    );\n    this.zoomSelection$.select('.line-mark').datum(this.data.heat.x[0]);\n    if (render) {\n      this.render();\n    }\n    return this;\n  }\n\n  setDomain(domain, render) {\n    if (!domain) return this;\n    const { z, ...rest } = domain;\n    super.setDomain(rest);\n    if (z && this.scale.z) {\n      this.scale.z.domain = z;\n      updateScale.call(this);\n      if (render) {\n        this.render();\n      }\n    }\n    return this;\n  }\n\n  setLabel(label, render) {\n    if (!label) return this;\n    const { z, ...rest } = label;\n    super.setLabel(rest);\n    if (z && this.scale.z) {\n      this.scale.z.label = z.label;\n      this.scale.z.subLabel = z.subLabel;\n      this.scale.z.unit = z.unit;\n      const tempText = `${this.scale.z.label || ''}${this.scale.z.subLabel ? ` ( ${this.scale.z.subLabel} )` : ''}${\n        this.scale.z.unit ? ` ( ${this.scale.z.unit} )` : ''\n      }`;\n      this.rootSelection$\n        .select('.heatLabel')\n        .select('text')\n        .attr('dx', util.measureSvgText(tempText, this.fontSize) / 2)\n        .text(tempText);\n      if (render) {\n        this.render();\n      }\n    }\n    return this;\n  }\n\n  downloadImage() {\n    const zCanvas = this.rootSelection$.select('canvas').node();\n    const svgDiv = this.rootSelection$.select('.svg');\n    const left = window.parseInt(svgDiv.style('left'));\n    const top = window.parseInt(svgDiv.style('top'));\n    super.downloadImage((this.scale.z || {}).label, {\n      image: zCanvas,\n      x: left,\n      y: top,\n    });\n  }\n\n  destroy() {\n    if (this.debounceDrawend$) {\n      this.debounceDrawend$.cancel();\n      this.debounceDrawend$ = null;\n    }\n    if (this.zScale$) this.zScale$ = null;\n    if (this.tempCanvas$) this.tempCanvas$ = {};\n    super.destroy();\n    return this;\n  }\n}\n\nexport default HeatMap;\n"],"file":"HeatMap.js"}